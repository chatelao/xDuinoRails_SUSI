# RCN-601

## SUSI-BiDi

Bidirectional Extension for SUSI Bus

***

## Contents

- [1 General](#1-general)
  - [1.1 Purpose of the Standard](#11-purpose-of-the-standard)
  - [1.2 Requirements](#12-requirements)
- [2 Properties](#2-properties)
  - [2.1 Special Features compared to RCN-600](#21-special-features-compared-to-rcn-600)
- [3 Protocol](#3-protocol)
  - [3.1 Reading CV Bank](#31-reading-cv-bank)
- [4 Commands (Host Call)](#4-commands-host-call)
- [5 BiDi Messages (BiDi-SUSI Module Responses)](#5-bidi-messages-bidi-susi-module-responses)
- [Appendix A: References to other Standards](#appendix-a-references-to-other-standards)
  - [A.1 Normative References](#a1-normative-references)
  - [A.2 Informative References](#a2-informative-references)
- [Appendix B: History](#appendix-b-history)

***

## 1 General

### 1.1 Purpose of the Standard

This standard describes an extended protocol for bidirectional communication between SUSI "Hosts" and "SUSI modules," sometimes simply referred to as "modules." The standard builds upon the standard SUSI communication and is compatible with it. Mixed operation of BiDi and standard modules is possible as long as they operate according to [RCN-600]. Deviations may occur with modules based on the old Dietz or NMRA standards (see [RCN-600] Appendix B: Identified Problems).

### 1.2 Requirements

To comply with this standard, the rules and commands defined herein must be followed. The fundamentals of [RCN-600] must be observed. It is not necessary to support all commands of the interface. This applies to both Hosts and SUSI modules. The usable/necessary functions should be listed in the description of the respective product.

## 2 Properties

Even with SUSI-BiDi, a maximum of 3 SUSI modules can be operated on one Host. The Host regularly calls all registered SUSI modules to allow them to respond. If data is available, the SUSI module responds to its BiDi call with an Acknowledge ("ACK"). The Host then generates 32 clock cycles to read the message from the SUSI module. Since the BiDi messages are sent on the normal data line, they can be read directly by the Host and other SUSI modules. A BiDi message always consists of 2 × two bytes. In the 1st and 3rd bytes, special BiDi identifiers are sent to maintain compatibility with the usual SUSI 2-byte commands. For the other SUSI modules on the SUSI bus, these are special command bytes. SUSI modules without SUSI-BiDi ignore these unknown commands. In bytes 2 and 4, the data bytes belonging to the BiDi identifier are transmitted.

### 2.1 Special Features compared to RCN-600

- The data line must always be in receive mode after a BiDi call (Pull-Up active).
- After each BiDi call, a pause of 4 to 5 ms must be maintained as a response window.

## 3 Protocol

- After a restart, the Host calls the 3 BiDi-SUSI modules with special BiDi commands. Connected BiDi-SUSI modules must always respond to these. The SUSI modules that respond are thus considered registered in the Host. If the SUSI module has no meaningful data to send, the function idle command is sent twice.
- During operation, the Host must call each registered BiDi-SUSI module at least every 100 ms. If response data is available, the BiDi-SUSI module outputs a 1 to 2 ms long "ACK" pulse no later than 2 ms after the last falling edge. A Host must accept "ACK" pulses of 0.5 ms or longer as valid.
- As soon as the "ACK" from the SUSI module is released, the Host sends 32 clock cycles in the normal time cycle. The Host only outputs the clock and keeps the data line in receive mode.
- After each rising clock edge, the SUSI module places its data bit on the bus.
- With each falling edge, the Host (and possibly other modules) reads the bit.
- The SUSI module removes its data from the data line 10 to 500 μs after the last negative edge and switches it to input. When reading a block, the SUSI module only switches the data line back to input if no further clock for reading comes within 50 μs or if it has already sent the checksum.
- The Host must pause for 1 to 1.5 ms after the last negative edge before sending a new command. Within the reading of a block, no pauses are inserted, and the clocks follow each other directly.
- A BiDi-SUSI module must always respond to a CV read command if the requested CV is in its CV range, even if it does not use it! A response with 0x8E + 0x01 (ERR 'not supported') is also permissible.

Figure 1 shows the timing of a bidirectional transmission. The blue pulse and the blue data are generated by the SUSI module.

### 3.1 Reading CV Bank

If a whole CV bank is to be read, a special procedure is used to make the transmission faster and more secure.

For the transmission, the special command CV Bank Read is used, which exists for each SUSI module individually. This allows selecting the SUSI module, defining the bank to be read, and starting the data transmission with one command. It always starts at the beginning of the bank, i.e., at CV 900, 940, or 980. This command works independently of the bank number in CV 1021, and this CV is not changed.

After the command, the Host expects an ACK that the SUSI module has understood the command and the selected bank is supported. Then the Host sends 32 clock cycles multiple times, with which the module transmits the BiDi command 0x8F, data byte, BiDi command 0x8F, data byte. This is usually done twenty times to transmit all 40 bytes of a bank. If the module has little data in a bank, it can abort the transmission by sending both bytes or just the second byte with 0x8E for CV not available.

Regardless of whether all 40 bytes were sent or the transmission was aborted, 32 more clock cycles for a checksum follow. The first byte contains a CRC checksum and the second byte the value 0. This is only transmitted to maintain the usual transmission of byte pairs for BiDi.

The checksum is formed as described in [RCN-218] section 1.3. On the sender side, it is formed according to the polynomial x^8 + x^5 + x^4 + 1 over all sent data bytes including the bytes sent with the BiDi command 0x8E, initialized to 0, not inverted. On the receiver side, the CRC is formed with the same polynomial over all CVs including the CRC; the result must be 0. Examples, informative notes, and algorithm suggestions are in Appendix C of [RCN-218].

When reading a CV bank, the following steps are performed:
- **Host:** Host sends 0x0C – <Bank#> = command Bank Read for SUSI module 1.
- **Module:** Module responds with an "ACK" if the bank is available. Without an ACK, the reading is aborted here.
- **Module:** Module sends two bytes per 32 clock cycles, each as 0x8F + CV value. This usually happens twenty times. Optional for premature termination of reading:
- **Module:** Module sends 0x8F + CV value + 0x8E + 0x01 (ERR 'not supported') or
- **Module:** Module sends 0x8E + 0x01 (ERR) + 0x8E + 0x01 (ERR). Both terminate the further data reading prematurely.
- **Module:** Module sends checksum as 0x8F + checksum + 0x8F + 0.

Afterward, the Host must maintain a 9 ms pause so that all SUSI modules can safely resynchronize for the following SUSI command. Up to this point, 1 + 20 x 2 + 2 = 43 commands have been sent without a pause. Before reading another block, the most important SUSI standard commands should be transmitted.

## 4 Commands (Host Call)

Each BiDi-Host call consists of 2 bytes. The range 0x0# is reserved for call commands.

| Command | Header | Data (Bit 7..0) | Remarks |
| :--- | :--- | :--- | :--- |
| BiDi Host Call | 0x01 | Bit 1 & 0 = Module Number (01=1, 10=2, 11=3) | |
| | | Bit 2 = Forced Response | If Bit 2 = 1, the SUSI module must respond with a status 0x8A. |
| | | Bit 3 = Status Address | Selects one of two status bytes (0x8A). 0 = Status 0 & 1, 1 = Status 2 & 3 |
| | | Bit 7..4 = reserved | |
| CV Bank Read from Module 1 | 0x0C | Bank No. (0-255) | For transferring a whole CV bank from SUSI module 1 |
| CV Bank Read from Module 2 | 0x0D | Bank No. (0-255) | For transferring a whole CV bank from SUSI module 2 |
| CV Bank Read from Module 3 | 0x0E | Bank No. (0-255) | For transferring a whole CV bank from SUSI module 3 |
| CV Read | 0x0F | CV No. – 769 | Modules only respond to requests for their own CVs according to [RCN-600] Table 1. |

**Table 1: BiDi Commands (Host Call)**

## 5 BiDi Messages (BiDi-SUSI Module Responses)

Each BiDi message consists of 4 bytes, which can be divided into 2 independent responses of 2 bytes each. Bytes 1 and 3 are header bytes, bytes 2 and 4 are data bytes. The range 0x80 to 0x8F is reserved for BiDi messages.

The position address mentioned in the table is an accessory decoder address. Via this accessory decoder address, a transmitter module in the track can report its position (as an address) to the vehicle passing over it. The corresponding receiver can be implemented as a BiDi-SUSI module and forward the received address as a position message to the Host and other SUSI modules. This can be used, for example, for location-based station announcements in the sound module.

- The position address is sent in pairs: Byte 1 & 2 = high, Byte 3 & 4 = low.
- The CV read response is sent in pairs: Byte 1 & 2 = value (CV No.), Byte 3 & 4 = value (CV No.+1).
- Note: If, for example, CV 939 is read from SUSI module 1, the automatic access to CV 940 leads to an error, which is transmitted as 0x8E 0x02.

All undefined values are reserved!

... *(and so on for all BiDi messages)*

## Appendix A: References to other Standards

### A.1 Normative References

The standards listed here must be adhered to in whole or in the scope indicated in the citation to comply with this standard.
- [RCN-600] RCN-600 SUSI Bus Module Expansion Interface
- [RCN-602] RCN-602 Configuration Variables for SUSI

### A.2 Informative References

The standards and documents listed here are purely for informational purposes and are not part of this standard.
- [RCN-212] RCN-212 DCC Operating Commands for Vehicle Decoders
- [RCN-213] RCN-213 DCC Operating Commands for Accessory Decoders
- [RCN-218] RCN-218 DCC-A – Automatic Registration

... *(rest of the appendices)*
